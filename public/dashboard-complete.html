<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸš– ××¢×¨×›×ª × ×™×”×•×œ ××•× ×™×•×ª - Dashboard ××§×¦×•×¢×™ ××œ×</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="modern.css">
  <link rel="stylesheet" href="responsive.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --border: #e2e8f0;
      --sidebar-width: 280px;
      --header-height: 70px;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background-color: var(--light);
      color: var(--dark);
      overflow-x: hidden;
    }

    /* ============================================
       SIDEBAR
    ============================================ */
    .sidebar {
      position: fixed;
      right: 0;
      top: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 25px 0;
      overflow-y: auto;
      box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 0 25px 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .sidebar-header h2 {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-header .user-info {
      margin-top: 15px;
      font-size: 14px;
      opacity: 0.9;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .sidebar-menu {
      list-style: none;
    }

    .menu-section {
      margin-bottom: 30px;
    }

    .menu-section-title {
      padding: 0 25px;
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.7;
      margin-bottom: 10px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .menu-item {
      padding: 14px 25px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      font-weight: 500;
      position: relative;
    }

    .menu-item:hover {
      background: rgba(255,255,255,0.1);
      padding-right: 30px;
    }

    .menu-item.active {
      background: rgba(255,255,255,0.15);
      border-right: 4px solid white;
    }

    .menu-item i {
      width: 20px;
      text-align: center;
      font-size: 18px;
    }

    .menu-item .badge {
      margin-right: auto;
      background: var(--danger);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
    }

    /* ============================================
       MAIN CONTENT
    ============================================ */
    .main-content {
      margin-right: var(--sidebar-width);
      min-height: 100vh;
    }

    .header {
      height: var(--header-height);
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 0 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-search {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--light);
      padding: 10px 20px;
      border-radius: 25px;
      width: 400px;
    }

    .header-search i {
      color: var(--gray);
    }

    .header-search input {
      border: none;
      background: none;
      outline: none;
      width: 100%;
      font-family: 'Heebo', sans-serif;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      position: relative;
    }

    .icon-btn:hover {
      background: var(--primary);
      color: white;
    }

    .badge-dot {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 8px;
      height: 8px;
      background: var(--danger);
      border-radius: 50%;
      border: 2px solid white;
    }

    .content-area {
      padding: 30px;
    }

    .page-header {
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray);
      font-size: 14px;
      margin-top: 5px;
    }

    /* ============================================
       STATS CARDS
    ============================================ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .stat-info h3 {
      font-size: 14px;
      color: var(--gray);
      font-weight: 500;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-change {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
      color: var(--gray);
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-icon.primary {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .stat-icon.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .stat-icon.warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .stat-icon.danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    /* ============================================
       CARDS
    ============================================ */
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }

    .card-header h2 {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ============================================
       BUTTONS
    ============================================ */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Heebo', sans-serif;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-secondary {
      background: var(--gray);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    /* ============================================
       TABLES
    ============================================ */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--light);
    }

    th {
      padding: 15px;
      text-align: right;
      font-weight: 600;
      font-size: 13px;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover {
      background: var(--light);
    }

    /* ============================================
       STATUS BADGES
    ============================================ */
    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status.success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .status.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .status.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .status.info { background: rgba(59, 130, 246, 0.1); color: var(--info); }

    /* ============================================
       FORMS
    ============================================ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* ============================================
       GRID
    ============================================ */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    /* ============================================
       MODALS
    ============================================ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-body {
      padding: 25px;
    }

    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ============================================
       LOADING & EMPTY STATES
    ============================================ */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 10px;
    }

    /* ============================================
       FILTERS BAR
    ============================================ */
    .filters-bar {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    /* ============================================
       ACTION MENU
    ============================================ */
    .action-menu {
      position: relative;
    }

    .action-btn {
      padding: 8px 12px;
      border: none;
      background: var(--light);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--border);
    }

    .action-dropdown {
      display: none;
      position: absolute;
      left: 0;
      top: 100%;
      margin-top: 5px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 180px;
      z-index: 100;
    }

    .action-dropdown.active {
      display: block;
    }

    .action-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
    }

    .action-dropdown-item:hover {
      background: var(--light);
    }

    /* ============================================
       CONTENT SECTIONS
    ============================================ */
    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* ============================================
       RESPONSIVE
    ============================================ */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(100%);
      }

      .sidebar.mobile-active {
        transform: translateX(0);
      }

      .main-content {
        margin-right: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }

      .header-search {
        width: 200px;
      }

      .filters-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>
        <i class="fas fa-taxi"></i>
        ××¢×¨×›×ª ××•× ×™×•×ª
      </h2>
      <div class="user-info">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div>
          <div style="font-weight: 600;">×× ×”×œ ×¨××©×™</div>
          <div style="font-size: 12px; opacity: 0.8;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8beaefe6e2e5cbffeaf3e2a5e8e4a5e2e7">[email&#160;protected]</a></div>
        </div>
      </div>
    </div>

    <ul class="sidebar-menu">
      <!-- Dashboard -->
      <li class="menu-section">
        <div class="menu-section-title">×¡×§×™×¨×” ×›×œ×œ×™×ª</div>
        <div class="menu-item active" data-page="dashboard">
          <i class="fas fa-home"></i>
          <span>×“×©×‘×•×¨×“</span>
        </div>
        <div class="menu-item" data-page="analytics">
          <i class="fas fa-chart-line"></i>
          <span>× ×™×ª×•×— × ×ª×•× ×™×</span>
        </div>
      </li>

      <!-- Rides -->
      <li class="menu-section">
        <div class="menu-section-title">× ×™×”×•×œ × ×¡×™×¢×•×ª</div>
        <div class="menu-item" data-page="rides-active">
          <i class="fas fa-car"></i>
          <span>× ×¡×™×¢×•×ª ×¤×¢×™×œ×•×ª</span>
          <span class="badge" id="activeRidesCount">0</span>
        </div>
        <div class="menu-item" data-page="rides-history">
          <i class="fas fa-history"></i>
          <span>×”×™×¡×˜×•×¨×™×™×ª × ×¡×™×¢×•×ª</span>
        </div>
        <div class="menu-item" data-page="rides-create">
          <i class="fas fa-plus-circle"></i>
          <span>× ×¡×™×¢×” ×—×“×©×”</span>
        </div>
        <div class="menu-item" data-page="rides-scheduled">
          <i class="fas fa-calendar-alt"></i>
          <span>× ×¡×™×¢×•×ª ××ª×•×–×× ×•×ª</span>
        </div>
      </li>

      <!-- Drivers -->
      <li class="menu-section">
        <div class="menu-section-title">× ×™×”×•×œ × ×”×’×™×</div>
        <div class="menu-item" data-page="drivers-list">
          <i class="fas fa-users"></i>
          <span>×¨×©×™××ª × ×”×’×™×</span>
        </div>
        <div class="menu-item" data-page="drivers-pending">
          <i class="fas fa-user-clock"></i>
          <span>×××ª×™× ×™× ×œ××™×©×•×¨</span>
          <span class="badge" id="pendingDriversCount">0</span>
        </div>
        <div class="menu-item" data-page="drivers-add">
          <i class="fas fa-user-plus"></i>
          <span>×”×•×¡×£ × ×”×’</span>
        </div>
        <div class="menu-item" data-page="drivers-blocked">
          <i class="fas fa-user-slash"></i>
          <span>× ×”×’×™× ×—×¡×•××™×</span>
        </div>
      </li>

      <!-- Customers -->
      <li class="menu-section">
        <div class="menu-section-title">× ×™×”×•×œ ×œ×§×•×—×•×ª</div>
        <div class="menu-item" data-page="customers-list">
          <i class="fas fa-address-book"></i>
          <span>×¨×©×™××ª ×œ×§×•×—×•×ª</span>
        </div>
        <div class="menu-item" data-page="customers-vip">
          <i class="fas fa-star"></i>
          <span>×œ×§×•×—×•×ª VIP</span>
        </div>
      </li>

      <!-- Finance -->
      <li class="menu-section">
        <div class="menu-section-title">× ×™×”×•×œ ×›×¡×¤×™×</div>
        <div class="menu-item" data-page="finance-overview">
          <i class="fas fa-dollar-sign"></i>
          <span>×¡×§×™×¨×” ×›×œ×œ×™×ª</span>
        </div>
        <div class="menu-item" data-page="finance-payments">
          <i class="fas fa-credit-card"></i>
          <span>×ª×©×œ×•××™×</span>
        </div>
        <div class="menu-item" data-page="finance-commissions">
          <i class="fas fa-percentage"></i>
          <span>×¢××œ×•×ª</span>
        </div>
        <div class="menu-item" data-page="finance-reports">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>×“×•×—×•×ª</span>
        </div>
      </li>

      <!-- Messages -->
      <li class="menu-section">
        <div class="menu-section-title">×ª×§×©×•×¨×ª</div>
        <div class="menu-item" data-page="messages-send">
          <i class="fas fa-paper-plane"></i>
          <span>×©×œ×— ×”×•×“×¢×•×ª</span>
        </div>
        <div class="menu-item" data-page="messages-templates">
          <i class="fas fa-file-alt"></i>
          <span>×ª×‘× ×™×•×ª ×”×•×“×¢×•×ª</span>
        </div>
        <div class="menu-item" data-page="messages-history">
          <i class="fas fa-comments"></i>
          <span>×”×™×¡×˜×•×¨×™×™×ª ×”×•×“×¢×•×ª</span>
        </div>
      </li>

      <!-- Settings -->
      <li class="menu-section">
        <div class="menu-section-title">×”×’×“×¨×•×ª</div>
        <div class="menu-item" data-page="settings-general">
          <i class="fas fa-cog"></i>
          <span>×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª</span>
        </div>
        <div class="menu-item" data-page="settings-pricing">
          <i class="fas fa-tags"></i>
          <span>× ×™×”×•×œ ××—×™×¨×™×</span>
        </div>
        <div class="menu-item" data-page="settings-groups">
          <i class="fas fa-users-cog"></i>
          <span>×§×‘×•×¦×•×ª WhatsApp</span>
        </div>
        <div class="menu-item" data-page="settings-bot">
          <i class="fas fa-robot"></i>
          <span>×”×’×“×¨×•×ª ×‘×•×˜</span>
        </div>
      </li>

      <!-- System -->
      <li class="menu-section">
        <div class="menu-section-title">××¢×¨×›×ª</div>
        <div class="menu-item" data-page="system-logs">
          <i class="fas fa-clipboard-list"></i>
          <span>×œ×•×’×™×</span>
        </div>
        <div class="menu-item" data-page="system-backup">
          <i class="fas fa-database"></i>
          <span>×’×™×‘×•×™ ×•×©×—×–×•×¨</span>
        </div>
        <div class="menu-item" data-page="system-dispatch">
          <i class="fas fa-broadcast-tower"></i>
          <span>×¡×˜×˜×•×¡ Dispatch</span>
        </div>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <div class="header-search">
        <i class="fas fa-search"></i>
        <input type="text" id="globalSearch" placeholder="×—×™×¤×•×© × ×¡×™×¢×•×ª, × ×”×’×™×, ×œ×§×•×—×•×ª...">
      </div>

      <div class="header-actions">
        <button class="icon-btn" onclick="refreshData()" title="×¨×¢× ×Ÿ × ×ª×•× ×™×">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button class="icon-btn" onclick="toggleNotifications()" title="×”×ª×¨××•×ª">
          <i class="fas fa-bell"></i>
          <span class="badge-dot" id="notificationBadge" style="display: none;"></span>
        </button>
        <button class="icon-btn" onclick="openSettings()" title="×”×’×“×¨×•×ª">
          <i class="fas fa-cog"></i>
        </button>
        <button class="icon-btn" onclick="logout()" title="×”×ª× ×ª×§">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area" id="contentArea">

      <!-- ================================================
           DASHBOARD SECTION
      ================================================ -->
      <div class="content-section active" id="dashboard">
        <div class="page-header">
          <div>
            <h1>ğŸ  ×“×©×‘×•×¨×“ ×¨××©×™</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>×¡×§×™×¨×” ×›×œ×œ×™×ª</span>
            </div>
          </div>
          <button class="btn btn-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i>
            ×¨×¢× ×Ÿ × ×ª×•× ×™×
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-info">
              <h3>× ×¡×™×¢×•×ª ×”×™×•×</h3>
              <div class="stat-value" id="todayRides">0</div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span id="ridesChange">×˜×•×¢×Ÿ...</span>
              </div>
            </div>
            <div class="stat-icon primary">
              <i class="fas fa-car"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>× ×”×’×™× ×¤×¢×™×œ×™×</h3>
              <div class="stat-value" id="activeDrivers">0</div>
              <div class="stat-change positive">
                <i class="fas fa-user-check"></i>
                <span id="driversStatus">××—×•×‘×¨×™×</span>
              </div>
            </div>
            <div class="stat-icon success">
              <i class="fas fa-users"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>×”×›× ×¡×•×ª ×”×™×•×</h3>
              <div class="stat-value">â‚ª<span id="todayRevenue">0</span></div>
              <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span id="revenueChange">×˜×•×¢×Ÿ...</span>
              </div>
            </div>
            <div class="stat-icon warning">
              <i class="fas fa-shekel-sign"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>×××ª×™× ×™× ×œ××™×©×•×¨</h3>
              <div class="stat-value" id="pendingApprovals">0</div>
              <div class="stat-change">
                <i class="fas fa-clock"></i>
                <span>×“×•×¨×© ×˜×™×¤×•×œ</span>
              </div>
            </div>
            <div class="stat-icon danger">
              <i class="fas fa-exclamation-circle"></i>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-bolt"></i> ×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h2>
          </div>
          <div class="grid-3">
            <button class="btn btn-primary" onclick="showPage('rides-create')">
              <i class="fas fa-plus"></i>
              × ×¡×™×¢×” ×—×“×©×”
            </button>
            <button class="btn btn-success" onclick="showPage('drivers-pending')">
              <i class="fas fa-user-check"></i>
              ××©×¨ × ×”×’×™× (<span id="pendingCount">0</span>)
            </button>
            <button class="btn btn-warning" onclick="showPage('messages-send')">
              <i class="fas fa-paper-plane"></i>
              ×©×œ×— ×”×•×“×¢×•×ª
            </button>
          </div>
        </div>

        <!-- Recent Rides -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-car"></i> × ×¡×™×¢×•×ª ××—×¨×•× ×•×ª</h2>
            <button class="btn btn-sm btn-outline" onclick="loadRecentRides()">
              <i class="fas fa-sync"></i>
              ×¨×¢× ×Ÿ
            </button>
          </div>
          <div id="recentRidesTable">
            <div class="loading active">
              <div class="spinner"></div>
              <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
            </div>
          </div>
        </div>

        <!-- System Status -->
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-robot"></i> ×¡×˜×˜×•×¡ ×‘×•×˜</h2>
            </div>
            <div id="botStatus">
              <div style="text-align: center; padding: 20px;">
                <div class="loading active">
                  <div class="spinner"></div>
                  <p>×‘×•×“×§ ×—×™×‘×•×¨...</p>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-chart-pie"></i> ×”×ª×¤×œ×’×•×ª × ×¡×™×¢×•×ª</h2>
            </div>
            <div id="ridesDistribution" style="min-height: 200px;">
              <canvas id="ridesChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- ================================================
           RIDES - ACTIVE
      ================================================ -->
      <div class="content-section" id="rides-active">
        <div class="page-header">
          <div>
            <h1>ğŸš— × ×¡×™×¢×•×ª ×¤×¢×™×œ×•×ª</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>× ×¡×™×¢×•×ª</span>
              <span>â€º</span>
              <span>×¤×¢×™×œ×•×ª</span>
            </div>
          </div>
          <button class="btn btn-primary" onclick="showPage('rides-create')">
            <i class="fas fa-plus"></i>
            × ×¡×™×¢×” ×—×“×©×”
          </button>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
          <div class="filter-group">
            <label>×¡×˜×˜×•×¡</label>
            <select class="form-control" id="ridesStatusFilter" onchange="filterRides()">
              <option value="all">×”×›×œ</option>
              <option value="created">× ×•×¦×¨</option>
              <option value="sent">× ×©×œ×—</option>
              <option value="locked">× ×¢×•×œ</option>
              <option value="assigned">××©×•×™×š</option>
              <option value="enroute">×‘×“×¨×š</option>
            </select>
          </div>
          <div class="filter-group">
            <label>× ×”×’</label>
            <select class="form-control" id="ridesDriverFilter" onchange="filterRides()">
              <option value="all">×›×œ ×”× ×”×’×™×</option>
            </select>
          </div>
          <div class="filter-group">
            <label>×—×™×¤×•×©</label>
            <input type="text" class="form-control" id="ridesSearchInput" placeholder="××¡×¤×¨ × ×¡×™×¢×”, ×œ×§×•×—, ×˜×œ×¤×•×Ÿ..." oninput="filterRides()">
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end;">
            <button class="btn btn-secondary" onclick="resetRidesFilters()">
              <i class="fas fa-redo"></i>
              × ×§×” ×¡×™× ×•× ×™×
            </button>
          </div>
        </div>

        <!-- Table -->
        <div class="card">
          <div id="ridesActiveTable">
            <div class="loading active">
              <div class="spinner"></div>
              <p>×˜×•×¢×Ÿ × ×¡×™×¢×•×ª...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ================================================
           RIDES - HISTORY
      ================================================ -->
      <div class="content-section" id="rides-history">
        <div class="page-header">
          <div>
            <h1>ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª × ×¡×™×¢×•×ª</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>× ×¡×™×¢×•×ª</span>
              <span>â€º</span>
              <span>×”×™×¡×˜×•×¨×™×”</span>
            </div>
          </div>
          <button class="btn btn-success" onclick="exportRides()">
            <i class="fas fa-file-excel"></i>
            ×™×™×¦× ×œ××§×¡×œ
          </button>
        </div>

        <div class="filters-bar">
          <div class="filter-group">
            <label>××ª××¨×™×š</label>
            <input type="date" class="form-control" id="historyDateFrom">
          </div>
          <div class="filter-group">
            <label>×¢×“ ×ª××¨×™×š</label>
            <input type="date" class="form-control" id="historyDateTo">
          </div>
          <div class="filter-group">
            <label>×¡×˜×˜×•×¡</label>
            <select class="form-control" id="historyStatusFilter">
              <option value="all">×”×›×œ</option>
              <option value="completed">×”×•×©×œ×</option>
              <option value="cancelled">×‘×•×˜×œ</option>
            </select>
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end;">
            <button class="btn btn-primary" onclick="loadRidesHistory()">
              <i class="fas fa-search"></i>
              ×—×¤×©
            </button>
          </div>
        </div>

        <div class="card">
          <div id="ridesHistoryTable">
            <div class="empty-state">
              <i class="fas fa-calendar-alt"></i>
              <h3>×‘×—×¨ ×˜×•×•×— ×ª××¨×™×›×™× ×œ×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×”</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- ================================================
           RIDES - CREATE NEW
      ================================================ -->
      <div class="content-section" id="rides-create">
        <div class="page-header">
          <div>
            <h1>â• × ×¡×™×¢×” ×—×“×©×”</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>× ×¡×™×¢×•×ª</span>
              <span>â€º</span>
              <span>×™×¦×™×¨×”</span>
            </div>
          </div>
        </div>

        <div class="card" style="max-width: 800px; margin: 0 auto;">
          <form id="createRideForm" onsubmit="return handleCreateRide(event)">
            <div class="grid-2">
              <div class="form-group">
                <label>ğŸ‘¤ ×©× ×”×œ×§×•×— *</label>
                <input type="text" class="form-control" name="customerName" required placeholder="×©× ××œ×">
              </div>
              <div class="form-group">
                <label>ğŸ“ ×˜×œ×¤×•×Ÿ *</label>
                <input type="tel" class="form-control" name="customerPhone" required placeholder="050-1234567" dir="ltr">
              </div>
            </div>

            <div class="form-group">
              <label>ğŸ“ ××§×•× ××™×¡×•×£ *</label>
              <input type="text" class="form-control" name="pickup" required placeholder="×¨×—×•×‘ ×”×¨×¦×œ 10, ×ª×œ ××‘×™×‘">
            </div>

            <div class="form-group">
              <label>ğŸ¯ ×™×¢×“ *</label>
              <input type="text" class="form-control" name="destination" required placeholder="×¨×—×•×‘ ×“×™×–× ×’×•×£ 50, ×ª×œ ××‘×™×‘">
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label>â° ×–××Ÿ ××ª×•×›× ×Ÿ (××•×¤×¦×™×•× ×œ×™)</label>
                <input type="datetime-local" class="form-control" name="scheduledTime">
              </div>
              <div class="form-group">
                <label>ğŸ’° ××—×™×¨ ××©×•×¢×¨</label>
                <input type="number" class="form-control" name="price" placeholder="0" min="0">
              </div>
            </div>

            <div class="form-group">
              <label>ğŸ“ ×”×¢×¨×•×ª</label>
              <textarea class="form-control" name="notes" rows="3" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea>
            </div>

            <div class="form-group">
              <label>ğŸ‘¨â€âœˆï¸ ×©×™×•×š ×™×“× ×™ ×œ× ×”×’ (××•×¤×¦×™×•× ×œ×™)</label>
              <select class="form-control" name="driverId">
                <option value="">×©×œ×— ×œ×›×œ ×”× ×”×’×™×</option>
              </select>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
              <button type="button" class="btn btn-secondary" onclick="resetCreateRideForm()">
                <i class="fas fa-redo"></i>
                × ×§×” ×˜×•×¤×¡
              </button>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-check"></i>
                ×¦×•×¨ × ×¡×™×¢×” ×•×©×œ×—
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ================================================
           DRIVERS - LIST
      ================================================ -->
      <div class="content-section" id="drivers-list">
        <div class="page-header">
          <div>
            <h1>ğŸ‘¨â€âœˆï¸ ×¨×©×™××ª × ×”×’×™×</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>× ×”×’×™×</span>
              <span>â€º</span>
              <span>×¨×©×™××”</span>
            </div>
          </div>
          <button class="btn btn-primary" onclick="showPage('drivers-add')">
            <i class="fas fa-user-plus"></i>
            ×”×•×¡×£ × ×”×’
          </button>
        </div>

        <div class="filters-bar">
          <div class="filter-group">
            <label>×¡×˜×˜×•×¡</label>
            <select class="form-control" id="driversStatusFilter" onchange="filterDrivers()">
              <option value="all">×”×›×œ</option>
              <option value="active">×¤×¢×™×œ×™×</option>
              <option value="blocked">×—×¡×•××™×</option>
            </select>
          </div>
          <div class="filter-group">
            <label>××™×•×Ÿ ×œ×¤×™</label>
            <select class="form-control" id="driversSortBy" onchange="filterDrivers()">
              <option value="name">×©×</option>
              <option value="rating">×“×™×¨×•×’</option>
              <option value="rides">× ×¡×™×¢×•×ª</option>
              <option value="earnings">×¨×•×•×—×™×</option>
            </select>
          </div>
          <div class="filter-group">
            <label>×—×™×¤×•×©</label>
            <input type="text" class="form-control" id="driversSearchInput" placeholder="×©×, ×˜×œ×¤×•×Ÿ, ×¨×›×‘..." oninput="filterDrivers()">
          </div>
        </div>

        <div class="card">
          <div id="driversListTable">
            <div class="loading active">
              <div class="spinner"></div>
              <p>×˜×•×¢×Ÿ × ×”×’×™×...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ================================================
           DRIVERS - PENDING APPROVAL
      ================================================ -->
      <div class="content-section" id="drivers-pending">
        <div class="page-header">
          <div>
            <h1>â³ ×××ª×™× ×™× ×œ××™×©×•×¨</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>× ×”×’×™×</span>
              <span>â€º</span>
              <span>××™×©×•×¨×™×</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div id="pendingDriversTable">
            <div class="loading active">
              <div class="spinner"></div>
              <p>×˜×•×¢×Ÿ × ×”×’×™× ×××ª×™× ×™×...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ================================================
           FINANCE - OVERVIEW
      ================================================ -->
      <div class="content-section" id="finance-overview">
        <div class="page-header">
          <div>
            <h1>ğŸ’° ×¡×§×™×¨×” ×›×¡×¤×™×ª</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>×›×¡×¤×™×</span>
              <span>â€º</span>
              <span>×¡×§×™×¨×”</span>
            </div>
          </div>
          <button class="btn btn-success" onclick="exportFinanceReport()">
            <i class="fas fa-file-pdf"></i>
            ×™×™×¦× ×“×•×—
          </button>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-info">
              <h3>×”×›× ×¡×•×ª ×”×—×•×“×©</h3>
              <div class="stat-value">â‚ª<span id="monthRevenue">0</span></div>
            </div>
            <div class="stat-icon success">
              <i class="fas fa-arrow-trend-up"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>×¢××œ×•×ª ×©× ×’×‘×•</h3>
              <div class="stat-value">â‚ª<span id="monthCommissions">0</span></div>
            </div>
            <div class="stat-icon primary">
              <i class="fas fa-percentage"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>×ª×©×œ×•××™× ×××ª×™× ×™×</h3>
              <div class="stat-value">â‚ª<span id="pendingPayments">0</span></div>
            </div>
            <div class="stat-icon warning">
              <i class="fas fa-clock"></i>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-info">
              <h3>×—×•×‘×•×ª</h3>
              <div class="stat-value">â‚ª<span id="totalDebts">0</span></div>
            </div>
            <div class="stat-icon danger">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-chart-line"></i> ×’×¨×£ ×”×›× ×¡×•×ª</h2>
          </div>
          <div id="revenueChart" style="min-height: 300px;">
            <canvas id="revenueChartCanvas"></canvas>
          </div>
        </div>
      </div>

      <!-- ================================================
           MESSAGES - SEND
      ================================================ -->
      <div class="content-section" id="messages-send">
        <div class="page-header">
          <div>
            <h1>âœ‰ï¸ ×©×œ×— ×”×•×“×¢×•×ª</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>×ª×§×©×•×¨×ª</span>
              <span>â€º</span>
              <span>×©×œ×™×—×”</span>
            </div>
          </div>
        </div>

        <div class="card" style="max-width: 800px; margin: 0 auto;">
          <form id="sendMessageForm" onsubmit="return handleSendMessage(event)">
            <div class="form-group">
              <label>ğŸ“± ×œ××™ ×œ×©×œ×•×—?</label>
              <select class="form-control" name="recipients" required>
                <option value="">×‘×—×¨...</option>
                <option value="all-drivers">×›×œ ×”× ×”×’×™×</option>
                <option value="active-drivers">× ×”×’×™× ×¤×¢×™×œ×™×</option>
                <option value="specific">× ×”×’ ×¡×¤×¦×™×¤×™</option>
                <option value="group">×§×‘×•×¦×ª WhatsApp</option>
              </select>
            </div>

            <div class="form-group" id="specificDriverGroup" style="display: none;">
              <label>ğŸ‘¨â€âœˆï¸ ×‘×—×¨ × ×”×’</label>
              <select class="form-control" name="driverId">
                <option value="">×‘×—×¨ × ×”×’...</option>
              </select>
            </div>

            <div class="form-group">
              <label>ğŸ“ ×ª×•×›×Ÿ ×”×”×•×“×¢×”</label>
              <textarea class="form-control" name="message" rows="6" required placeholder="×›×ª×•×‘ ××ª ×”×”×•×“×¢×” ×›××Ÿ..."></textarea>
              <small>××•×¨×š: <span id="messageLength">0</span> ×ª×•×•×™×</small>
            </div>

            <div class="form-group">
              <label>ğŸ“‹ ×ª×‘× ×™×•×ª</label>
              <select class="form-control" onchange="insertTemplate(this.value)">
                <option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>
                <option value="welcome">×‘×¨×•×›×™× ×”×‘××™×</option>
                <option value="reminder">×ª×–×›×•×¨×ª ×ª×©×œ×•×</option>
                <option value="update">×¢×“×›×•×Ÿ ××¢×¨×›×ª</option>
              </select>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
              <button type="button" class="btn btn-secondary" onclick="resetSendMessageForm()">
                <i class="fas fa-redo"></i>
                × ×§×”
              </button>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-paper-plane"></i>
                ×©×œ×— ×”×•×“×¢×”
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ================================================
           SETTINGS - GENERAL
      ================================================ -->
      <div class="content-section" id="settings-general">
        <div class="page-header">
          <div>
            <h1>âš™ï¸ ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>×”×’×“×¨×•×ª</span>
              <span>â€º</span>
              <span>×›×œ×œ×™×•×ª</span>
            </div>
          </div>
        </div>

        <div class="card" style="max-width: 800px; margin: 0 auto;">
          <form id="generalSettingsForm" onsubmit="return saveGeneralSettings(event)">
            <h3 style="margin-bottom: 20px;">ğŸ¢ ×¤×¨×˜×™ ×”×—×‘×¨×”</h3>
            
            <div class="form-group">
              <label>×©× ×”×—×‘×¨×”</label>
              <input type="text" class="form-control" name="companyName" value="××•× ×™×•×ª ×“×¨×š ×¦×“×™×§×™×">
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label>×˜×œ×¤×•×Ÿ</label>
                <input type="tel" class="form-control" name="companyPhone" value="03-1234567">
              </div>
              <div class="form-group">
                <label>××™××™×™×œ</label>
                <input type="email" class="form-control" name="companyEmail" value="info@taxi.co.il">
              </div>
            </div>

            <h3 style="margin: 30px 0 20px;">ğŸ’¼ ×”×’×“×¨×•×ª ×¢×¡×§×™×•×ª</h3>

            <div class="grid-2">
              <div class="form-group">
                <label>××—×•×– ×¢××œ×” (%)</label>
                <input type="number" class="form-control" name="commissionRate" value="10" min="0" max="100" step="0.1">
              </div>
              <div class="form-group">
                <label>××˜×‘×¢</label>
                <select class="form-control" name="currency">
                  <option value="ILS" selected>×©×§×œ (â‚ª)</option>
                  <option value="USD">×“×•×œ×¨ ($)</option>
                  <option value="EUR">×™×•×¨×• (â‚¬)</option>
                </select>
              </div>
            </div>

            <h3 style="margin: 30px 0 20px;">ğŸ”” ×”×ª×¨××•×ª</h3>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="notifyNewRide" checked>
                <span>×”×ª×¨××” ×¢×œ × ×¡×™×¢×” ×—×“×©×”</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="notifyNewDriver" checked>
                <span>×”×ª×¨××” ×¢×œ × ×”×’ ×—×“×©</span>
              </label>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i>
                ×©××•×¨ ×©×™× ×•×™×™×
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ================================================
           SETTINGS - GROUPS
      ================================================ -->
      <div class="content-section" id="settings-groups">
        <div class="page-header">
          <div>
            <h1>ğŸ“± ×§×‘×•×¦×•×ª WhatsApp</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>×”×’×“×¨×•×ª</span>
              <span>â€º</span>
              <span>×§×‘×•×¦×•×ª</span>
            </div>
          </div>
          <button class="btn btn-primary" onclick="syncWhatsAppGroups()">
            <i class="fas fa-sync"></i>
            ×¡× ×›×¨×Ÿ ×§×‘×•×¦×•×ª
          </button>
        </div>

        <div class="card">
          <div id="whatsappGroupsTable">
            <div class="loading active">
              <div class="spinner"></div>
              <p>×˜×•×¢×Ÿ ×§×‘×•×¦×•×ª...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ================================================
           SYSTEM - DISPATCH STATUS
      ================================================ -->
      <div class="content-section" id="system-dispatch">
        <div class="page-header">
          <div>
            <h1>ğŸ“¡ ×¡×˜×˜×•×¡ Dispatch Manager</h1>
            <div class="breadcrumb">
              <i class="fas fa-home"></i>
              <span>××¢×¨×›×ª</span>
              <span>â€º</span>
              <span>Dispatch</span>
            </div>
          </div>
          <button class="btn btn-warning" onclick="switchDispatchMode()">
            <i class="fas fa-exchange-alt"></i>
            ×”×—×œ×£ ××¦×‘
          </button>
        </div>

        <div class="card">
          <div id="dispatchStatusInfo">
            <div class="loading active">
              <div class="spinner"></div>
              <p>×‘×•×“×§ ×¡×˜×˜×•×¡...</p>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-robot"></i> ×‘×•×˜ WhatsApp</h2>
            </div>
            <div id="botHealthStatus">
              <p>×˜×•×¢×Ÿ...</p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2><i class="fas fa-sms"></i> Twilio</h2>
            </div>
            <div id="twilioHealthStatus">
              <p>×˜×•×¢×Ÿ...</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    </div>
  </div>

  <!-- ================================================
       MODALS
  ================================================ -->
  <div class="modal" id="rideDetailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>×¤×¨×˜×™ × ×¡×™×¢×” ××œ××™×</h3>
        <button onclick="closeModal('rideDetailsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray);">&times;</button>
      </div>
      <div class="modal-body" id="rideDetailsContent">
        <!-- Content loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('rideDetailsModal')">×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <div class="modal" id="driverDetailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>×¤×¨×˜×™ × ×”×’ ××œ××™×</h3>
        <button onclick="closeModal('driverDetailsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray);">&times;</button>
      </div>
      <div class="modal-body" id="driverDetailsContent">
        <!-- Content loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('driverDetailsModal')">×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Include External JS Modules (if available) -->
  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="/js/rides.js" onerror="console.log('rides.js not loaded')"></script>
  <script src="/js/drivers.js" onerror="console.log('drivers.js not loaded')"></script>
  <script src="/js/customers.js" onerror="console.log('customers.js not loaded')"></script>
  <script src="/js/finance.js" onerror="console.log('finance.js not loaded')"></script>
  <script src="/js/messages.js" onerror="console.log('messages.js not loaded')"></script>
  <script src="/js/settings.js" onerror="console.log('settings.js not loaded')"></script>
  <script src="/js/system.js" onerror="console.log('system.js not loaded')"></script>
  <script src="/js/dashboard.js" onerror="console.log('dashboard.js not loaded')"></script>

  <script>
    // ============================================
    // ğŸš€ GLOBAL STATE & CONFIG
    // ============================================
    const API_BASE = window.location.origin;
    let currentPage = 'dashboard';
    let authToken = localStorage.getItem('authToken');
    
    // Global data stores
    let ridesData = [];
    let driversData = [];
    let customersData = [];
    let groupsData = [];

    // ============================================
    // ğŸ” AUTHENTICATION CHECK
    // ============================================
    function checkAuth() {
      if (!authToken) {
        console.warn('No auth token - redirecting to login');
        // Uncomment when login is ready:
        // window.location.href = '/login.html';
        // return false;
      }
      return true;
    }

    // ============================================
    // ğŸ“¡ API HELPER FUNCTIONS
    // ============================================
    async function apiRequest(endpoint, options = {}) {
      try {
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };

        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers
        });

        if (response.status === 401) {
          console.warn('Unauthorized - clearing token');
          localStorage.removeItem('authToken');
          // window.location.href = '/login.html';
          return null;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        return data;
        
      } catch (error) {
        console.error('API Request Error:', error);
        showNotification('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ' + error.message, 'error');
        return null;
      }
    }

    // ============================================
    // ğŸ§­ NAVIGATION SYSTEM
    // ============================================
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function() {
        const page = this.dataset.page;
        if (page) {
          showPage(page);
        }
      });
    });

    function showPage(pageName) {
      console.log('ğŸ“„ Navigating to:', pageName);
      
      // Update sidebar active state
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      const menuItem = document.querySelector(`[data-page="${pageName}"]`);
      if (menuItem) {
        menuItem.classList.add('active');
      }

      // Update content section
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      const section = document.getElementById(pageName);
      if (section) {
        section.classList.add('active');
        currentPage = pageName;
        
        // Load page data
        loadPageData(pageName);
      } else {
        console.warn('âš ï¸ Page section not found:', pageName);
      }
    }

    // ============================================
    // ğŸ“¦ PAGE DATA LOADING DISPATCHER
    // ============================================
    function loadPageData(pageName) {
      console.log('ğŸ“¥ Loading data for:', pageName);
      
      switch(pageName) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'analytics':
          loadAnalytics();
          break;
        case 'rides-active':
          loadActiveRides();
          break;
        case 'rides-history':
          setupRidesHistoryPage();
          break;
        case 'rides-create':
          loadDriversForRideForm();
          break;
        case 'rides-scheduled':
          loadScheduledRides();
          break;
        case 'drivers-list':
          loadDriversList();
          break;
        case 'drivers-pending':
          loadPendingDrivers();
          break;
        case 'drivers-add':
          console.log('Driver add form ready');
          break;
        case 'drivers-blocked':
          loadBlockedDrivers();
          break;
        case 'customers-list':
          loadCustomersList();
          break;
        case 'customers-vip':
          loadVIPCustomers();
          break;
        case 'finance-overview':
          loadFinanceOverview();
          break;
        case 'finance-payments':
          loadPayments();
          break;
        case 'finance-commissions':
          loadCommissions();
          break;
        case 'finance-reports':
          loadFinanceReports();
          break;
        case 'messages-send':
          loadDriversForMessage();
          break;
        case 'messages-templates':
          loadMessageTemplates();
          break;
        case 'messages-history':
          loadMessagesHistory();
          break;
        case 'settings-general':
          loadGeneralSettings();
          break;
        case 'settings-pricing':
          loadPricingSettings();
          break;
        case 'settings-groups':
          loadWhatsAppGroups();
          break;
        case 'settings-bot':
          loadBotSettings();
          break;
        case 'system-logs':
          loadSystemLogs();
          break;
        case 'system-backup':
          loadBackupOptions();
          break;
        case 'system-dispatch':
          loadDispatchStatus();
          break;
        default:
          console.log('â„¹ï¸ No specific loader for:', pageName);
      }
    }

    // ============================================
    // ğŸ  DASHBOARD LOADING
    // ============================================
    async function loadDashboard() {
      console.log('ğŸ“Š Loading dashboard...');
      
      try {
        // Load statistics
        const stats = await apiRequest('/api/statistics');
        
        if (stats) {
          document.getElementById('todayRides').textContent = stats.todayRides || 0;
          document.getElementById('activeDrivers').textContent = stats.activeDrivers || 0;
          document.getElementById('todayRevenue').textContent = (stats.todayRevenue || 0).toLocaleString();
          document.getElementById('pendingApprovals').textContent = stats.pendingDrivers || 0;
          document.getElementById('pendingCount').textContent = stats.pendingDrivers || 0;
          
          // Update badges
          document.getElementById('activeRidesCount').textContent = stats.activeRides || 0;
          document.getElementById('pendingDriversCount').textContent = stats.pendingDrivers || 0;
        }

        // Load recent rides
        await loadRecentRides();

        // Load bot status
        await loadBotStatus();
        
        console.log('âœ… Dashboard loaded successfully');
        
      } catch (error) {
        console.error('âŒ Error loading dashboard:', error);
        showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×©×‘×•×¨×“', 'error');
      }
    }

    async function refreshDashboard() {
      showNotification('××¨×¢× ×Ÿ × ×ª×•× ×™×...', 'info');
      await loadDashboard();
      showNotification('×”× ×ª×•× ×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”! âœ…', 'success');
    }

    async function loadRecentRides() {
      const container = document.getElementById('recentRidesTable');
      if (!container) return;

      container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>×˜×•×¢×Ÿ × ×¡×™×¢×•×ª ××—×¨×•× ×•×ª...</p></div>';

      try {
        const rides = await apiRequest('/api/rides?limit=10&sort=-createdAt');
        
        if (!rides || rides.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-car"></i><h3>××™×Ÿ × ×¡×™×¢×•×ª ××—×¨×•× ×•×ª</h3><p>×‘×¨×’×¢ ×©×ª×”×™×” × ×¡×™×¢×” ×—×“×©×”, ×”×™× ×ª×•×¤×™×¢ ×›××Ÿ</p></div>';
          return;
        }

        let html = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>××¡×¤×¨</th>
                  <th>×œ×§×•×—</th>
                  <th>××¡×œ×•×œ</th>
                  <th>× ×”×’</th>
                  <th>×¡×˜×˜×•×¡</th>
                  <th>×–××Ÿ</th>
                  <th>×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody>
        `;

        rides.forEach(ride => {
          html += `
            <tr style="cursor: pointer;" onmouseover="this.style.backgroundColor='var(--light)'" onmouseout="this.style.backgroundColor=''">
              <td><strong>#${ride.rideNumber || 'N/A'}</strong></td>
              <td>
                <div>${ride.customerName}</div>
                <div style="font-size: 11px; color: var(--gray);" dir="ltr">${ride.customerPhone}</div>
              </td>
              <td>
                <div style="font-size: 12px;">
                  <div>ğŸ“ ${truncate(ride.pickup, 25)}</div>
                  <div style="margin-top: 3px;">ğŸ¯ ${truncate(ride.destination, 25)}</div>
                </div>
              </td>
              <td>${ride.driverName || '<span style="color: var(--gray);">×œ× ××©×•×™×š</span>'}</td>
              <td>${getStatusBadge(ride.status)}</td>
              <td style="white-space: nowrap;">${formatDate(ride.createdAt)}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="viewRide('${ride._id}')" title="×¦×¤×” ×‘×¤×¨×˜×™×">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

      } catch (error) {
        console.error('Error loading recent rides:', error);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>×©×’×™××” ×‘×˜×¢×™× ×ª × ×¡×™×¢×•×ª</h3></div>';
      }
    }

    async function loadBotStatus() {
      const container = document.getElementById('botStatus');
      if (!container) return;

      try {
        const status = await apiRequest('/api/bot/stats');
        
        if (status && status.connected) {
          container.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <div style="font-size: 64px; color: var(--success); margin-bottom: 20px; animation: pulse 2s infinite;">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3 style="color: var(--success); margin-bottom: 10px; font-size: 24px;">××—×•×‘×¨ ×•×¤×¢×™×œ! âœ…</h3>
              <p style="color: var(--gray); font-size: 14px;">×”×‘×•×˜ ×¢×•×‘×“ ×›×¨××•×™ ×•××©×œ×— × ×¡×™×¢×•×ª</p>
              <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                <p style="margin: 0;"><strong style="font-size: 32px; color: var(--primary);">${status.totalSent || 0}</strong></p>
                <p style="margin: 5px 0 0; color: var(--gray); font-size: 12px;">× ×¡×™×¢×•×ª × ×©×œ×—×• ×”×™×•×</p>
              </div>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <div style="font-size: 64px; color: var(--danger); margin-bottom: 20px;">
                <i class="fas fa-times-circle"></i>
              </div>
              <h3 style="color: var(--danger); margin-bottom: 10px;">×œ× ××—×•×‘×¨ âŒ</h3>
              <p style="color: var(--gray); margin-bottom: 20px;">×‘×•×˜ WhatsApp ××™× ×• ×¤×¢×™×œ ×›×¨×’×¢</p>
              <button class="btn btn-warning btn-sm" onclick="alert('×× × ×‘×“×•×§ ××ª ×—×™×‘×•×¨ ×”×‘×•×˜ ×•×”×¤×¢×œ ××—×“×© ××ª ×”×©×¨×ª')">
                <i class="fas fa-question-circle"></i>
                ×¢×–×¨×”
              </button>
            </div>
          `;
        }
      } catch (error) {
        container.innerHTML = `
          <div style="text-align: center; padding: 30px; color: var(--gray);">
            <i class="fas fa-question" style="font-size: 48px; opacity: 0.3;"></i>
            <p style="margin-top: 15px;">×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×¡×˜×˜×•×¡ ×”×‘×•×˜</p>
          </div>
        `;
      }
    }

    // ============================================
    // ğŸš— RIDES MANAGEMENT
    // ============================================
    async function loadActiveRides() {
      const container = document.getElementById('ridesActiveTable');
      if (!container) return;

      container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>×˜×•×¢×Ÿ × ×¡×™×¢×•×ª ×¤×¢×™×œ×•×ª...</p></div>';

      try {
        // Check if external module exists
        if (typeof ridesManager !== 'undefined' && ridesManager.loadActiveRides) {
          await ridesManager.loadActiveRides();
          return;
        }

        // Fallback implementation
        const rides = await apiRequest('/api/rides?status=created,sent,locked,assigned,enroute');
        
        if (!rides || rides.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-car"></i>
              <h3>××™×Ÿ × ×¡×™×¢×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢</h3>
              <p>×›×œ ×”× ×¡×™×¢×•×ª ×”×¤×¢×™×œ×•×ª ×™×•×¤×™×¢×• ×›××Ÿ</p>
              <button class="btn btn-primary" onclick="showPage('rides-create')" style="margin-top: 20px;">
                <i class="fas fa-plus"></i>
                ×¦×•×¨ × ×¡×™×¢×” ×—×“×©×”
              </button>
            </div>
          `;
          return;
        }

        ridesData = rides;
        renderRidesTable(rides, container);

        // Update filter dropdown with drivers
        const driverFilter = document.getElementById('ridesDriverFilter');
        if (driverFilter) {
          const uniqueDrivers = [...new Set(rides.filter(r => r.driverPhone).map(r => ({
            phone: r.driverPhone,
            name: r.driverName
          })))];
          
          let html = '<option value="all">×›×œ ×”× ×”×’×™×</option>';
          uniqueDrivers.forEach(driver => {
            html += `<option value="${driver.phone}">${driver.name}</option>`;
          });
          driverFilter.innerHTML = html;
        }

      } catch (error) {
        console.error('Error loading active rides:', error);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×¡×™×¢×•×ª</h3></div>';
      }
    }

    function renderRidesTable(rides, container) {
      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>××¡×¤×¨ × ×¡×™×¢×”</th>
                <th>×œ×§×•×—</th>
                <th>×˜×œ×¤×•×Ÿ</th>
                <th>××™×¡×•×£</th>
                <th>×™×¢×“</th>
                <th>××—×™×¨</th>
                <th>× ×”×’</th>
                <th>×¡×˜×˜×•×¡</th>
                <th>×–××Ÿ</th>
                <th>×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody>
      `;

      rides.forEach(ride => {
        html += `
          <tr>
            <td><strong style="color: var(--primary);">#${ride.rideNumber || 'N/A'}</strong></td>
            <td><strong>${ride.customerName}</strong></td>
            <td dir="ltr" style="font-family: monospace;">${ride.customerPhone}</td>
            <td>${truncate(ride.pickup, 35)}</td>
            <td>${truncate(ride.destination, 35)}</td>
            <td><strong>â‚ª${ride.price || 0}</strong></td>
            <td>${ride.driverName || '<span style="color: var(--gray);">â€”</span>'}</td>
            <td>${getStatusBadge(ride.status)}</td>
            <td style="white-space: nowrap; font-size: 12px;">${formatDate(ride.createdAt)}</td>
            <td>
              <div style="display: flex; gap: 5px;">
                <button class="btn btn-sm btn-primary" onclick="viewRide('${ride._id}')" title="×¦×¤×” ×‘×¤×¨×˜×™×">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      html += `<div style="margin-top: 15px; text-align: center; color: var(--gray); font-size: 14px;">×¡×”"×› ${rides.length} × ×¡×™×¢×•×ª</div>`;
      
      container.innerHTML = html;
    }

    function filterRides() {
      const status = document.getElementById('ridesStatusFilter')?.value || 'all';
      const driver = document.getElementById('ridesDriverFilter')?.value || 'all';
      const search = document.getElementById('ridesSearchInput')?.value.toLowerCase() || '';

      let filtered = [...ridesData];

      if (status !== 'all') {
        filtered = filtered.filter(r => r.status === status);
      }

      if (driver !== 'all') {
        filtered = filtered.filter(r => r.driverPhone === driver);
      }

      if (search) {
        filtered = filtered.filter(r => 
          r.rideNumber?.toString().includes(search) ||
          r.customerName?.toLowerCase().includes(search) ||
          r.customerPhone?.includes(search) ||
          r.pickup?.toLowerCase().includes(search) ||
          r.destination?.toLowerCase().includes(search)
        );
      }

      const container = document.getElementById('ridesActiveTable');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><h3>×œ× × ××¦××• ×ª×•×¦××•×ª</h3><p>× ×¡×” ×œ×©× ×•×ª ××ª ×”×¡×™× ×•×Ÿ</p></div>';
      } else {
        renderRidesTable(filtered, container);
      }
    }

    function resetRidesFilters() {
      document.getElementById('ridesStatusFilter').value = 'all';
      document.getElementById('ridesDriverFilter').value = 'all';
      document.getElementById('ridesSearchInput').value = '';
      filterRides();
    }

    function setupRidesHistoryPage() {
      // Set default dates
      const today = new Date();
      const lastWeek = new Date(today);
      lastWeek.setDate(lastWeek.getDate() - 7);
      
      const dateFrom = document.getElementById('historyDateFrom');
      const dateTo = document.getElementById('historyDateTo');
      
      if (dateFrom && dateTo) {
        dateFrom.value = lastWeek.toISOString().split('T')[0];
        dateTo.value = today.toISOString().split('T')[0];
      }
    }

    async function loadRidesHistory() {
      const container = document.getElementById('ridesHistoryTable');
      if (!container) return;

      const dateFrom = document.getElementById('historyDateFrom')?.value;
      const dateTo = document.getElementById('historyDateTo')?.value;
      const status = document.getElementById('historyStatusFilter')?.value || 'all';

      if (!dateFrom || !dateTo) {
        showNotification('×× × ×‘×—×¨ ×˜×•×•×— ×ª××¨×™×›×™×', 'warning');
        return;
      }

      container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...</p></div>';

      try {
        let url = `/api/rides?from=${dateFrom}&to=${dateTo}`;
        if (status !== 'all') {
          url += `&status=${status}`;
        }

        const rides = await apiRequest(url);
        
        if (!rides || rides.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><h3>×œ× × ××¦××• × ×¡×™×¢×•×ª ×‘×ª×§×•×¤×” ×–×•</h3></div>';
          return;
        }

        renderRidesTable(rides, container);

      } catch (error) {
        console.error('Error loading history:', error);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”</h3></div>';
      }
    }

    async function viewRide(rideId) {
      try {
        const ride = await apiRequest(`/api/rides/${rideId}`);
        if (ride) {
          showRideDetails(ride);
        }
      } catch (error) {
        console.error('Error fetching ride:', error);
        showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”× ×¡×™×¢×”', 'error');
      }
    }

    function showRideDetails(ride) {
      const content = document.getElementById('rideDetailsContent');
      content.innerHTML = `
        <div style="padding: 10px;">
          <div style="background: var(--light); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h2 style="color: var(--primary); margin-bottom: 15px;">× ×¡×™×¢×” #${ride.rideNumber || 'N/A'}</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
              <div>
                <p style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">×œ×§×•×—</p>
                <p style="font-weight: 600;">${ride.customerName}</p>
              </div>
              <div>
                <p style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">×˜×œ×¤×•×Ÿ</p>
                <p style="font-weight: 600;" dir="ltr">${ride.customerPhone}</p>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;"><i class="fas fa-route"></i> ××¡×œ×•×œ</h4>
            <div style="background: white; border: 2px solid var(--border); border-radius: 8px; padding: 15px;">
              <p style="margin-bottom: 10px;"><strong>ğŸ“ ××™×¡×•×£:</strong> ${ride.pickup}</p>
              <p><strong>ğŸ¯ ×™×¢×“:</strong> ${ride.destination}</p>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
            <div>
              <p style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">××—×™×¨</p>
              <p style="font-size: 24px; font-weight: 700; color: var(--success);">â‚ª${ride.price || 0}</p>
            </div>
            <div>
              <p style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">×¡×˜×˜×•×¡</p>
              <div>${getStatusBadge(ride.status)}</div>
            </div>
          </div>

          ${ride.driverName ? `
            <div style="background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="margin-bottom: 10px;"><i class="fas fa-user"></i> × ×”×’</h4>
              <p><strong>×©×:</strong> ${ride.driverName}</p>
              <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${ride.driverPhone || '-'}</p>
            </div>
          ` : '<div style="padding: 15px; background: var(--warning); color: white; border-radius: 8px; margin-bottom: 20px;"><i class="fas fa-exclamation-triangle"></i> × ×¡×™×¢×” ×œ× ××©×•×™×›×ª ×œ× ×”×’</div>'}

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
            <div>
              <p style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">× ×•×¦×¨ ×‘×ª××¨×™×š</p>
              <p>${formatDate(ride.createdAt)}</p>
            </div>
            ${ride.completedAt ? `
            <div>
              <p style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">×”×•×©×œ× ×‘×ª××¨×™×š</p>
              <p>${formatDate(ride.completedAt)}</p>
            </div>
            ` : ''}
          </div>

          ${ride.notes ? `
            <div style="background: var(--light); padding: 15px; border-radius: 8px;">
              <h4 style="margin-bottom: 10px;"><i class="fas fa-comment"></i> ×”×¢×¨×•×ª</h4>
              <p>${ride.notes}</p>
            </div>
          ` : ''}

          ${ride.rating ? `
            <div style="background: var(--light); padding: 15px; border-radius: 8px; margin-top: 15px;">
              <h4 style="margin-bottom: 10px;"><i class="fas fa-star"></i> ×“×™×¨×•×’</h4>
              <p style="font-size: 24px;">${'â­'.repeat(ride.rating.stars)}</p>
              ${ride.rating.feedback ? `<p style="margin-top: 10px; color: var(--gray);">"${ride.rating.feedback}"</p>` : ''}
            </div>
          ` : ''}
        </div>
      `;
      openModal('rideDetailsModal');
    }

    // ============================================
    // â• CREATE RIDE
    // ============================================
    async function loadDriversForRideForm() {
      try {
        const drivers = await apiRequest('/api/drivers?status=active');
        const select = document.querySelector('#createRideForm select[name="driverId"]');
        
        if (select && drivers) {
          let html = '<option value="">×©×œ×— ×œ×›×œ ×”× ×”×’×™× (××•×˜×•××˜×™)</option>';
          drivers.forEach(driver => {
            html += `<option value="${driver._id}">${driver.name} - ${driver.phone}</option>`;
          });
          select.innerHTML = html;
        }
      } catch (error) {
        console.error('Error loading drivers for form:', error);
      }
    }

    async function handleCreateRide(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      
      const rideData = {
        customerName: formData.get('customerName'),
        customerPhone: formData.get('customerPhone'),
        pickup: formData.get('pickup'),
        destination: formData.get('destination'),
        scheduledTime: formData.get('scheduledTime') || null,
        price: parseFloat(formData.get('price')) || 0,
        notes: formData.get('notes') || '',
        driverId: formData.get('driverId') || null
      };

      // Validate
      if (!rideData.customerName || !rideData.customerPhone || !rideData.pickup || !rideData.destination) {
        showNotification('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”', 'warning');
        return false;
      }

      try {
        showNotification('×™×•×¦×¨ × ×¡×™×¢×”...', 'info');
        
        const result = await apiRequest('/api/rides', {
          method: 'POST',
          body: JSON.stringify(rideData)
        });

        if (result) {
          showNotification('âœ… × ×¡×™×¢×” × ×•×¦×¨×” ×•× ×©×œ×—×” ×‘×”×¦×œ×—×”!', 'success');
          form.reset();
          
          // Navigate to active rides after 1.5 seconds
          setTimeout(() => {
            showPage('rides-active');
          }, 1500);
        } else {
          showNotification('×©×’×™××” ×‘×™×¦×™×¨×ª ×”× ×¡×™×¢×”', 'error');
        }
      } catch (error) {
        console.error('Error creating ride:', error);
        showNotification('×©×’×™××” ×‘×™×¦×™×¨×ª ×”× ×¡×™×¢×”: ' + error.message, 'error');
      }

      return false;
    }

    function resetCreateRideForm() {
      document.getElementById('createRideForm').reset();
    }

    // ============================================
    // ğŸ‘¨â€âœˆï¸ DRIVERS MANAGEMENT
    // ============================================
    async function loadDriversList() {
      const container = document.getElementById('driversListTable');
      if (!container) return;

      container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>×˜×•×¢×Ÿ × ×”×’×™×...</p></div>';

      try {
        // Check if external module exists
        if (typeof driversManager !== 'undefined' && driversManager.loadDriversList) {
          await driversManager.loadDriversList();
          return;
        }

        // Fallback
        const drivers = await apiRequest('/api/drivers');
        
        if (!drivers || drivers.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-users"></i>
              <h3>××™×Ÿ × ×”×’×™× ×‘××¢×¨×›×ª</h3>
              <p>×”×ª×—×œ ×¢×œ ×™×“×™ ×”×•×¡×¤×ª × ×”×’ ×—×“×©</p>
              <button class="btn btn-primary" onclick="showPage('drivers-add')" style="margin-top: 20px;">
                <i class="fas fa-user-plus"></i>
                ×”×•×¡×£ × ×”×’ ×¨××©×•×Ÿ
              </button>
            </div>
          `;
          return;
        }

        driversData = drivers;
        renderDriversTable(drivers, container);

      } catch (error) {
        console.error('Error loading drivers:', error);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×”×’×™×</h3></div>';
      }
    }

    function renderDriversTable(drivers, container) {
      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>×©× ××œ×</th>
                <th>×˜×œ×¤×•×Ÿ</th>
                <th>××¡×¤×¨ ×¨×›×‘</th>
                <th>×“×™×¨×•×’</th>
                <th>× ×¡×™×¢×•×ª</th>
                <th>×¨×•×•×—×™×</th>
                <th>×¡×˜×˜×•×¡</th>
                <th>×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody>
      `;

      drivers.forEach(driver => {
        const rating = driver.rating?.average || 5;
        const ratingStars = 'â­'.repeat(Math.round(rating));
        const statusClass = driver.isBlocked ? 'danger' : (driver.isActive ? 'success' : 'warning');
        const statusText = driver.isBlocked ? '×—×¡×•×' : (driver.isActive ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ');

        html += `
          <tr>
            <td><strong>${driver.name}</strong></td>
            <td dir="ltr" style="font-family: monospace;">${driver.phone}</td>
            <td>${driver.vehicleNumber || 'â€”'}</td>
            <td title="${rating.toFixed(1)}/5">${ratingStars} <small style="color: var(--gray);">(${rating.toFixed(1)})</small></td>
            <td><strong>${driver.stats?.totalRides || 0}</strong></td>
            <td><strong style="color: var(--success);">â‚ª${(driver.earnings?.total || 0).toLocaleString()}</strong></td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
            <td>
              <div style="display: flex; gap: 5px;">
                <button class="btn btn-sm btn-primary" onclick="viewDriver('${driver._id}')" title="×¦×¤×” ×‘×¤×¨×˜×™×">
                  <i class="fas fa-eye"></i>
                </button>
                ${driver.isBlocked ? 
                  `<button class="btn btn-sm btn-success" onclick="unblockDriver('${driver._id}')" title="×‘×˜×œ ×—×¡×™××”">
                    <i class="fas fa-unlock"></i>
                  </button>` :
                  `<button class="btn btn-sm btn-warning" onclick="blockDriver('${driver._id}')" title="×—×¡×•×">
                    <i class="fas fa-ban"></i>
                  </button>`
                }
              </div>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      html += `<div style="margin-top: 15px; text-align: center; color: var(--gray); font-size: 14px;">×¡×”"×› ${drivers.length} × ×”×’×™×</div>`;
      
      container.innerHTML = html;
    }

    async function loadPendingDrivers() {
      const container = document.getElementById('pendingDriversTable');
      if (!container) return;

      container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>×˜×•×¢×Ÿ × ×”×’×™× ×××ª×™× ×™×...</p></div>';

      try {
        const pending = await apiRequest('/api/registrations/pending');
        
        if (!pending || pending.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-check-circle" style="color: var(--success);"></i>
              <h3>××¢×•×œ×”! ××™×Ÿ × ×”×’×™× ×××ª×™× ×™× ×œ××™×©×•×¨</h3>
              <p>×›×œ ×”× ×”×’×™× ×˜×•×¤×œ×•</p>
            </div>
          `;
          document.getElementById('pendingDriversCount').textContent = '0';
          document.getElementById('pendingApprovals').textContent = '0';
          document.getElementById('pendingCount').textContent = '0';
          return;
        }

        // Update badges
        const count = pending.length;
        document.getElementById('pendingDriversCount').textContent = count;
        document.getElementById('pendingApprovals').textContent = count;
        document.getElementById('pendingCount').textContent = count;

        let html = `
          <div style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong> ${count} × ×”×’×™× ×××ª×™× ×™× ×œ××™×©×•×¨!</strong>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>×©× ××œ×</th>
                  <th>×˜×œ×¤×•×Ÿ</th>
                  <th>×ª.×–.</th>
                  <th>××¡×¤×¨ ×¨×›×‘</th>
                  <th>×ª××¨×™×š ×”×’×©×”</th>
                  <th>×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody>
        `;

        pending.forEach(driver => {
          html += `
            <tr>
              <td><strong>${driver.name}</strong></td>
              <td dir="ltr" style="font-family: monospace;">${driver.phone}</td>
              <td>${driver.idNumber || 'â€”'}</td>
              <td>${driver.vehicleNumber || 'â€”'}</td>
              <td style="white-space: nowrap;">${formatDate(driver.createdAt)}</td>
              <td>
                <div style="display: flex; gap: 5px;">
                  <button class="btn btn-sm btn-success" onclick="approveDriver('${driver._id}')" title="××©×¨ × ×”×’">
                    <i class="fas fa-check"></i> ××©×¨
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="rejectDriver('${driver._id}')" title="×“×—×” × ×”×’">
                    <i class="fas fa-times"></i> ×“×—×”
                  </button>
                </div>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

      } catch (error) {
        console.error('Error loading pending drivers:', error);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3></div>';
      }
    }

    async function approveDriver(driverId) {
      if (!confirm('×”×× ×œ××©×¨ × ×”×’ ×–×”? ×”×•× ×™×•×›×œ ×œ×”×ª×—×™×œ ×œ×§×‘×œ × ×¡×™×¢×•×ª.')) return;

      try {
        showNotification('×××©×¨ × ×”×’...', 'info');
        
        const result = await apiRequest(`/api/registrations/${driverId}/approve`, {
          method: 'POST'
        });

        if (result) {
          showNotification('âœ… × ×”×’ ××•×©×¨ ×‘×”×¦×œ×—×”!', 'success');
          await loadPendingDrivers();
          await loadDashboard(); // Refresh dashboard stats
        }
      } catch (error) {
        console.error('Error approving driver:', error);
        showNotification('×©×’×™××” ×‘××™×©×•×¨ ×”× ×”×’', 'error');
      }
    }

    async function rejectDriver(driverId) {
      const reason = prompt('×× × ×¦×™×™×Ÿ ×¡×™×‘×ª ×”×“×—×™×™×”:');
      if (!reason || reason.trim() === '') {
        showNotification('×—×•×‘×” ×œ×¦×™×™×Ÿ ×¡×™×‘×” ×œ×“×—×™×™×”', 'warning');
        return;
      }

      try {
        showNotification('×“×•×—×” × ×”×’...', 'info');
        
        const result = await apiRequest(`/api/registrations/${driverId}/reject`, {
          method: 'POST',
          body: JSON.stringify({ reason })
        });

        if (result) {
          showNotification('× ×”×’ × ×“×—×”', 'success');
          await loadPendingDrivers();
          await loadDashboard();
        }
      } catch (error) {
        console.error('Error rejecting driver:', error);
        showNotification('×©×’×™××” ×‘×“×—×™×™×ª ×”× ×”×’', 'error');
      }
    }

    async function blockDriver(driverId) {
      const reason = prompt('×¡×™×‘×ª ×”×—×¡×™××”:');
      if (!reason) return;

      try {
        const result = await apiRequest(`/api/drivers/${driverId}/block`, {
          method: 'POST',
          body: JSON.stringify({ reason })
        });

        if (result) {
          showNotification('× ×”×’ × ×—×¡×', 'success');
          await loadDriversList();
        }
      } catch (error) {
        showNotification('×©×’×™××” ×‘×—×¡×™××ª ×”× ×”×’', 'error');
      }
    }

    async function unblockDriver(driverId) {
      if (!confirm('×”×× ×œ×‘×˜×œ ××ª ×—×¡×™××ª ×”× ×”×’?')) return;

      try {
        const result = await apiRequest(`/api/drivers/${driverId}/unblock`, {
          method: 'POST'
        });

        if (result) {
          showNotification('×—×¡×™××” ×‘×•×˜×œ×”', 'success');
          await loadDriversList();
        }
      } catch (error) {
        showNotification('×©×’×™××” ×‘×‘×™×˜×•×œ ×”×—×¡×™××”', 'error');
      }
    }

    function filterDrivers() {
      const status = document.getElementById('driversStatusFilter')?.value || 'all';
      const sortBy = document.getElementById('driversSortBy')?.value || 'name';
      const search = document.getElementById('driversSearchInput')?.value.toLowerCase() || '';

      let filtered = [...driversData];

      // Filter by status
      if (status === 'active') {
        filtered = filtered.filter(d => d.isActive && !d.isBlocked);
      } else if (status === 'blocked') {
        filtered = filtered.filter(d => d.isBlocked);
      }

      // Filter by search
      if (search) {
        filtered = filtered.filter(d => 
          d.name?.toLowerCase().includes(search) ||
          d.phone?.includes(search) ||
          d.vehicleNumber?.toLowerCase().includes(search)
        );
      }

      // Sort
      filtered.sort((a, b) => {
        switch(sortBy) {
          case 'rating':
            return (b.rating?.average || 0) - (a.rating?.average || 0);
          case 'rides':
            return (b.stats?.totalRides || 0) - (a.stats?.totalRides || 0);
          case 'earnings':
            return (b.earnings?.total || 0) - (a.earnings?.total || 0);
          default: // name
            return (a.name || '').localeCompare(b.name || '');
        }
      });

      const container = document.getElementById('driversListTable');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><h3>×œ× × ××¦××• ×ª×•×¦××•×ª</h3></div>';
      } else {
        renderDriversTable(filtered, container);
      }
    }

    async function viewDriver(driverId) {
      try {
        const driver = await apiRequest(`/api/drivers/${driverId}`);
        if (driver) {
          // Open in new tab
          window.open(`/driver-profile.html?id=${driverId}`, '_blank');
        }
      } catch (error) {
        console.error('Error fetching driver:', error);
        showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”× ×”×’', 'error');
      }
    }

    // ============================================
    // ğŸ’° FINANCE
    // ============================================
    async function loadFinanceOverview() {
      try {
        const stats = await apiRequest('/api/analytics?period=month');
        
        if (stats) {
          document.getElementById('monthRevenue').textContent = (stats.revenue || 0).toLocaleString();
          document.getElementById('monthCommissions').textContent = (stats.commissions || 0).toLocaleString();
          document.getElementById('pendingPayments').textContent = (stats.pendingPayments || 0).toLocaleString();
          document.getElementById('totalDebts').textContent = (stats.debts || 0).toLocaleString();
        }
      } catch (error) {
        console.error('Error loading finance overview:', error);
      }
    }

    // ============================================
    // âœ‰ï¸ MESSAGES
    // ============================================
    async function loadDriversForMessage() {
      try {
        const drivers = await apiRequest('/api/drivers?status=active');
        const select = document.querySelector('#sendMessageForm select[name="driverId"]');
        
        if (select && drivers) {
          let html = '<option value="">×‘×—×¨ × ×”×’...</option>';
          drivers.forEach(driver => {
            html += `<option value="${driver._id}">${driver.name} - ${driver.phone}</option>`;
          });
          select.innerHTML = html;
        }
      } catch (error) {
        console.error('Error loading drivers for message:', error);
      }

      // Message length counter
      const textarea = document.querySelector('#sendMessageForm textarea[name="message"]');
      if (textarea) {
        textarea.addEventListener('input', function() {
          document.getElementById('messageLength').textContent = this.value.length;
        });
      }

      // Recipients change handler
      const recipientsSelect = document.querySelector('#sendMessageForm select[name="recipients"]');
      if (recipientsSelect) {
        recipientsSelect.addEventListener('change', function() {
          const specificGroup = document.getElementById('specificDriverGroup');
          if (this.value === 'specific' && specificGroup) {
            specificGroup.style.display = 'block';
          } else if (specificGroup) {
            specificGroup.style.display = 'none';
          }
        });
      }
    }

    async function handleSendMessage(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      
      const recipients = formData.get('recipients');
      const message = formData.get('message');

      if (!recipients || !message) {
        showNotification('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'warning');
        return false;
      }

      const messageData = {
        recipients: recipients,
        driverId: formData.get('driverId') || null,
        message: message
      };

      try {
        showNotification('×©×•×œ×— ×”×•×“×¢×”...', 'info');
        
        const result = await apiRequest('/api/bot/send-message', {
          method: 'POST',
          body: JSON.stringify(messageData)
        });

        if (result) {
          showNotification('âœ‰ï¸ ×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!', 'success');
          form.reset();
          document.getElementById('messageLength').textContent = '0';
        }
      } catch (error) {
        console.error('Error sending message:', error);
        showNotification('×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”', 'error');
      }

      return false;
    }

    function resetSendMessageForm() {
      document.getElementById('sendMessageForm').reset();
      document.getElementById('messageLength').textContent = '0';
    }

    function insertTemplate(template) {
      const textarea = document.querySelector('#sendMessageForm textarea[name="message"]');
      if (!textarea || !template) return;

      const templates = {
        welcome: '×©×œ×•× ×•×‘×¨×•×›×™× ×”×‘××™×! ğŸ‰\n\n×× ×—× ×• ×©××—×™× ×©×”×¦×˜×¨×¤×ª ×œ××¢×¨×›×ª ×”××•× ×™×•×ª ×©×œ× ×•. ××¦×¤×™× ×œ×¢×‘×•×“×” ×¤×•×¨×™×™×” ×•××•×¦×œ×—×ª ×‘×™×—×“!\n\n×”×¦×œ×—×” ×¨×‘×”! ğŸš–',
        reminder: '×ª×–×›×•×¨×ª ×ª×©×œ×•× ğŸ’³\n\n×©×œ×•×,\n×× × ×œ×©×œ× ××ª ×”×¢××œ×” ×”×—×•×“×©×™×ª ×‘×”×§×“× ×”××¤×©×¨×™.\n\n×ª×•×“×” ×¨×‘×” ×¢×œ ×”×©×™×ª×•×£ ×¤×¢×•×œ×”!',
        update: '×¢×“×›×•×Ÿ ××¢×¨×›×ª ğŸ”„\n\n×©×œ×•×,\n×”××¢×¨×›×ª ×¢×•×“×›× ×” ×œ×’×¨×¡×” ×—×“×©×” ×¢× ×©×™×¤×•×¨×™× ×•×‘×™×¦×•×¢×™× ×˜×•×‘×™× ×™×•×ª×¨.\n\n× ×©××— ×œ×©××•×¢ ××©×•×‘!'
      };

      textarea.value = templates[template] || '';
      document.getElementById('messageLength').textContent = textarea.value.length;
    }

    // ============================================
    // âš™ï¸ SETTINGS - WHATSAPP GROUPS
    // ============================================
    async function loadWhatsAppGroups() {
      const container = document.getElementById('whatsappGroupsTable');
      if (!container) return;

      container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>×˜×•×¢×Ÿ ×§×‘×•×¦×•×ª WhatsApp...</p></div>';

      try {
        const groups = await apiRequest('/api/groups');
        
        if (!groups || groups.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-whatsapp" style="font-size: 64px; color: #25D366;"></i>
              <h3>××™×Ÿ ×§×‘×•×¦×•×ª WhatsApp</h3>
              <p>×”×‘×•×˜ ×¦×¨×™×š ×œ×”×™×•×ª ××—×•×‘×¨ ×›×“×™ ×œ×¨××•×ª ××ª ×”×§×‘×•×¦×•×ª</p>
              <button class="btn btn-primary" onclick="syncWhatsAppGroups()" style="margin-top: 20px;">
                <i class="fas fa-sync"></i>
                ×¡× ×›×¨×Ÿ ×§×‘×•×¦×•×ª
              </button>
            </div>
          `;
          return;
        }

        groupsData = groups;

        let html = `
          <div style="margin-bottom: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
            <p><i class="fas fa-info-circle"></i> <strong>× ××¦××• ${groups.length} ×§×‘×•×¦×•×ª</strong></p>
            <p style="margin-top: 5px; font-size: 13px; color: var(--gray);">×§×‘×•×¦×•×ª ×¤×¢×™×œ×•×ª ×™×§×‘×œ×• × ×¡×™×¢×•×ª ××•×˜×•××˜×™×ª</p>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>×©× ×”×§×‘×•×¦×”</th>
                  <th>××–×”×” ×§×‘×•×¦×”</th>
                  <th>×¡×˜×˜×•×¡</th>
                  <th>×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody>
        `;

        groups.forEach(group => {
          html += `
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <i class="fab fa-whatsapp" style="color: #25D366; font-size: 20px;"></i>
                  <strong>${group.name}</strong>
                </div>
              </td>
              <td style="font-size: 11px; direction: ltr; font-family: monospace; color: var(--gray);">${group.groupId}</td>
              <td><span class="status ${group.isActive ? 'success' : 'warning'}">${group.isActive ? '×¤×¢×™×œ âœ…' : '×œ× ×¤×¢×™×œ'}</span></td>
              <td>
                <button class="btn btn-sm ${group.isActive ? 'btn-warning' : 'btn-success'}" onclick="toggleGroup('${group._id}', ${!group.isActive})">
                  <i class="fas fa-${group.isActive ? 'pause' : 'play'}"></i>
                  ${group.isActive ? '×”×©×‘×ª' : '×”×¤×¢×œ'}
                </button>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

      } catch (error) {
        console.error('Error loading groups:', error);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×‘×•×¦×•×ª</h3></div>';
      }
    }

    async function syncWhatsAppGroups() {
      showNotification('××¡× ×›×¨×Ÿ ×§×‘×•×¦×•×ª ××”×‘×•×˜...', 'info');
      
      try {
        const result = await apiRequest('/api/bot/sync-groups', { 
          method: 'POST' 
        });
        
        if (result) {
          showNotification('âœ… ×§×‘×•×¦×•×ª ×¡×•× ×›×¨× ×• ×‘×”×¦×œ×—×”!', 'success');
          await loadWhatsAppGroups();
        }
      } catch (error) {
        console.error('Error syncing groups:', error);
        showNotification('×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ×§×‘×•×¦×•×ª. ×•×“× ×©×”×‘×•×˜ ××—×•×‘×¨.', 'error');
      }
    }

    async function toggleGroup(groupId, activate) {
      try {
        const result = await apiRequest(`/api/groups/${groupId}`, {
          method: 'PUT',
          body: JSON.stringify({ isActive: activate })
        });

        if (result) {
          showNotification(activate ? '×§×‘×•×¦×” ×”×•×¤×¢×œ×” âœ…' : '×§×‘×•×¦×” ×”×•×©×‘×ª×”', 'success');
          await loadWhatsAppGroups();
        }
      } catch (error) {
        console.error('Error toggling group:', error);
        showNotification('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×§×‘×•×¦×”', 'error');
      }
    }

    // ============================================
    // ğŸ“¡ DISPATCH STATUS
    // ============================================
    async function loadDispatchStatus() {
      const container = document.getElementById('dispatchStatusInfo');
      if (!container) return;

      container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>×‘×•×“×§ ×¡×˜×˜×•×¡ Dispatch...</p></div>';

      try {
        const status = await apiRequest('/api/dispatch/status');
        
        if (status) {
          const currentModeIcon = status.currentMode === 'bot' ? 'ğŸ¤–' : 'ğŸ“±';
          const currentModeColor = status.currentMode === 'bot' ? 'var(--success)' : 'var(--warning)';
          
          container.innerHTML = `
            <div style="padding: 30px; text-align: center;">
              <div style="font-size: 64px; margin-bottom: 20px;">${currentModeIcon}</div>
              <h2 style="color: ${currentModeColor}; margin-bottom: 15px;">
                ××¦×‘ × ×•×›×—×™: ${status.currentMode === 'bot' ? '×‘×•×˜ WhatsApp' : 'Twilio SMS'}
              </h2>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; text-align: right;">
                <div style="padding: 20px; background: var(--light); border-radius: 8px;">
                  <h4 style="margin-bottom: 10px;"><i class="fas fa-robot"></i> ×‘×•×˜ WhatsApp</h4>
                  <p><strong>×–××™×Ÿ:</strong> ${status.botAvailable ? 'âœ… ×›×Ÿ' : 'âŒ ×œ×'}</p>
                  <p style="margin-top: 5px;"><strong>× ×©×œ×—×•:</strong> ${status.stats?.botSent || 0}</p>
                </div>
                
                <div style="padding: 20px; background: var(--light); border-radius: 8px;">
                  <h4 style="margin-bottom: 10px;"><i class="fas fa-sms"></i> Twilio SMS</h4>
                  <p><strong>×–××™×Ÿ:</strong> ${status.twilioAvailable ? 'âœ… ×›×Ÿ' : 'âŒ ×œ×'}</p>
                  <p style="margin-top: 5px;"><strong>× ×©×œ×—×•:</strong> ${status.stats?.twilioSent || 0}</p>
                </div>
              </div>

              <div style="margin-top: 30px; padding: 20px; background: var(--info); color: white; border-radius: 8px;">
                <p style="margin: 0;"><i class="fas fa-info-circle"></i> ×”××¢×¨×›×ª ×¢×•×‘×¨×ª ××•×˜×•××˜×™×ª ×œ-Twilio ×× ×”×‘×•×˜ ×œ× ×–××™×Ÿ</p>
              </div>
            </div>
          `;
        }

        await loadBotHealthStatus();
        await loadTwilioHealthStatus();

      } catch (error) {
        console.error('Error loading dispatch status:', error);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×˜×˜×•×¡</h3></div>';
      }
    }

    async function loadBotHealthStatus() {
      const container = document.getElementById('botHealthStatus');
      if (!container) return;

      try {
        const health = await apiRequest('/api/bot/stats');
        
        const isConnected = health && health.connected;
        
        container.innerHTML = `
          <div style="padding: 30px; text-align: center;">
            <div style="font-size: 48px; color: ${isConnected ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 15px;">
              <i class="fas fa-${isConnected ? 'check-circle' : 'times-circle'}"></i>
            </div>
            <h4 style="margin-bottom: 10px;">${isConnected ? '××—×•×‘×¨ ×•×¤×¢×™×œ âœ…' : '×œ× ××—×•×‘×¨ âŒ'}</h4>
            ${isConnected ? `
              <p style="color: var(--gray); margin-top: 10px;">
                <strong>${health.totalSent || 0}</strong> × ×¡×™×¢×•×ª × ×©×œ×—×•
              </p>
            ` : ''}
          </div>
        `;
      } catch (error) {
        container.innerHTML = '<p style="padding: 30px; text-align: center; color: var(--gray);">×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×¡×˜×˜×•×¡</p>';
      }
    }

    async function loadTwilioHealthStatus() {
      const container = document.getElementById('twilioHealthStatus');
      if (!container) return;

      try {
        // Check if Twilio is configured (this is a simplification)
        const dispatchStatus = await apiRequest('/api/dispatch/status');
        const isConfigured = dispatchStatus && dispatchStatus.twilioAvailable;
        
        container.innerHTML = `
          <div style="padding: 30px; text-align: center;">
            <div style="font-size: 48px; color: ${isConfigured ? 'var(--success)' : 'var(--warning)'}; margin-bottom: 15px;">
              <i class="fas fa-${isConfigured ? 'check-circle' : 'exclamation-triangle'}"></i>
            </div>
            <h4>${isConfigured ? '××•×’×“×¨ âœ…' : '×œ× ××•×’×“×¨'}</h4>
          </div>
        `;
      } catch (error) {
        container.innerHTML = '<p style="padding: 30px; text-align: center; color: var(--gray);">×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×¡×˜×˜×•×¡</p>';
      }
    }

    async function switchDispatchMode() {
      if (!confirm('×”×× ×œ×”×—×œ×™×£ ××¦×‘ Dispatch? ×”××¢×¨×›×ª ×ª×¢×‘×•×¨ ×‘×™×Ÿ ×‘×•×˜ ×œ-Twilio.')) return;

      try {
        showNotification('××—×œ×™×£ ××¦×‘...', 'info');
        
        const result = await apiRequest('/api/dispatch/switch-mode', {
          method: 'POST'
        });

        if (result) {
          showNotification('âœ… ××¦×‘ ×”×•×—×œ×£ ×‘×”×¦×œ×—×”!', 'success');
          await loadDispatchStatus();
        }
      } catch (error) {
        console.error('Error switching dispatch mode:', error);
        showNotification('×©×’×™××” ×‘×”×—×œ×¤×ª ××¦×‘', 'error');
      }
    }

    // ============================================
    // ğŸ› ï¸ UTILITY FUNCTIONS
    // ============================================
    function formatDate(dateString) {
      if (!dateString) return 'â€”';
      try {
        const date = new Date(dateString);
        return date.toLocaleString('he-IL', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString;
      }
    }

    function truncate(str, length) {
      if (!str) return '';
      return str.length > length ? str.substring(0, length) + '...' : str;
    }

    function getStatusBadge(status) {
      const statusMap = {
        created: { class: 'info', icon: 'plus-circle', text: '× ×•×¦×¨' },
        sent: { class: 'info', icon: 'paper-plane', text: '× ×©×œ×—' },
        locked: { class: 'warning', icon: 'lock', text: '× ×¢×•×œ' },
        assigned: { class: 'primary', icon: 'user-check', text: '××©×•×™×š' },
        enroute: { class: 'warning', icon: 'car', text: '×‘×“×¨×š' },
        completed: { class: 'success', icon: 'check-circle', text: '×”×•×©×œ×' },
        cancelled: { class: 'danger', icon: 'times-circle', text: '×‘×•×˜×œ' }
      };

      const s = statusMap[status] || { class: 'info', icon: 'question-circle', text: status };
      return `<span class="status ${s.class}"><i class="fas fa-${s.icon}"></i> ${s.text}</span>`;
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notif = document.createElement('div');
      
      const colors = {
        success: 'var(--success)',
        error: 'var(--danger)',
        warning: 'var(--warning)',
        info: 'var(--info)'
      };
      
      notif.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${colors[type] || colors.info};
        color: white;
        padding: 15px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        animation: slideDown 0.3s;
        font-weight: 600;
        min-width: 300px;
        text-align: center;
      `;
      notif.textContent = message;
      document.body.appendChild(notif);

      setTimeout(() => {
        notif.style.animation = 'slideUp 0.3s';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
      }
    });

    function refreshData() {
      loadPageData(currentPage);
      showNotification('×”× ×ª×•× ×™× ×¨×•×¢× ×• âœ…', 'success');
    }

    function openSettings() {
      showPage('settings-general');
    }

    function toggleNotifications() {
      showNotification('×”×ª×¨××•×ª × ×¤×ª×—×•', 'info');
    }

    function logout() {
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
        localStorage.removeItem('authToken');
        window.location.href = '/login.html';
      }
    }

    // ============================================
    // ğŸ” GLOBAL SEARCH
    // ============================================
    const globalSearch = document.getElementById('globalSearch');
    if (globalSearch) {
      globalSearch.addEventListener('input', debounce(handleGlobalSearch, 500));
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    async function handleGlobalSearch(event) {
      const query = event.target.value.trim();
      if (query.length < 3) return;

      console.log('ğŸ” Global search for:', query);
      // TODO: Implement comprehensive global search
      // Search across rides, drivers, customers
    }

    // ============================================
    // ğŸ“ PLACEHOLDER FUNCTIONS (TO BE IMPLEMENTED)
    // ============================================
    function loadAnalytics() { 
      const container = document.querySelector('#analytics .content-section');
      if (container) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><h3>Analytics - Coming Soon</h3></div>';
      }
    }
    
    function loadScheduledRides() { 
      console.log('loadScheduledRides - TODO'); 
    }
    
    function loadBlockedDrivers() { 
      const container = document.getElementById('driversBlockedTable');
      if (container) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-user-slash"></i><h3>× ×”×’×™× ×—×¡×•××™× - ×‘×§×¨×•×‘</h3></div>';
      }
    }
    
    function loadCustomersList() { console.log('loadCustomersList - TODO'); }
    function loadVIPCustomers() { console.log('loadVIPCustomers - TODO'); }
    function loadPayments() { console.log('loadPayments - TODO'); }
    function loadCommissions() { console.log('loadCommissions - TODO'); }
    function loadFinanceReports() { console.log('loadFinanceReports - TODO'); }
    function exportFinanceReport() { showNotification('××™×™×¦× ×“×•×—...', 'info'); }
    function exportRides() { showNotification('××™×™×¦× ×œ××§×¡×œ...', 'info'); }
    function loadMessageTemplates() { console.log('loadMessageTemplates - TODO'); }
    function loadMessagesHistory() { console.log('loadMessagesHistory - TODO'); }
    function loadGeneralSettings() { console.log('loadGeneralSettings - TODO'); }
    function saveGeneralSettings(e) { e.preventDefault(); showNotification('×”×’×“×¨×•×ª × ×©××¨×• âœ…', 'success'); return false; }
    function loadPricingSettings() { console.log('loadPricingSettings - TODO'); }
    function loadBotSettings() { console.log('loadBotSettings - TODO'); }
    function loadSystemLogs() { console.log('loadSystemLogs - TODO'); }
    function loadBackupOptions() { console.log('loadBackupOptions - TODO'); }

    // ============================================
    // ğŸš€ INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Dashboard Complete System - Initializing...');
      console.log('ğŸ“ URL:', window.location.href);
      console.log('ğŸ” Auth Token:', authToken ? 'Present' : 'Missing');
      
      // Check authentication
      checkAuth();

      // Load initial page (dashboard)
      console.log('ğŸ“Š Loading dashboard...');
      loadPageData('dashboard');

      // Add animation styles
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { transform: translate(-50%, -100%); opacity: 0; }
          to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideUp {
          from { transform: translate(-50%, 0); opacity: 1; }
          to { transform: translate(-50%, -100%); opacity: 0; }
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.6; }
        }
      `;
      document.head.appendChild(style);

      console.log('âœ… Dashboard Complete System - Ready!');
      console.log('ğŸ“± Available pages:', [
        'dashboard', 'analytics',
        'rides-active', 'rides-history', 'rides-create', 'rides-scheduled',
        'drivers-list', 'drivers-pending', 'drivers-add', 'drivers-blocked',
        'customers-list', 'customers-vip',
        'finance-overview', 'finance-payments', 'finance-commissions', 'finance-reports',
        'messages-send', 'messages-templates', 'messages-history',
        'settings-general', 'settings-pricing', 'settings-groups', 'settings-bot',
        'system-logs', 'system-backup', 'system-dispatch'
      ].join(', '));
    });

    // Log any JavaScript errors
    window.addEventListener('error', function(event) {
      console.error('âŒ JavaScript Error:', event.error);
    });

    console.log('ğŸ“œ Script loaded successfully');
  </script>

</body>
</html>